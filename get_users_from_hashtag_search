from selenium import webdriver
from selenium.webdriver.common.keys import Keys
from time import sleep
from selenium.webdriver import ActionChains
from selenium.webdriver.common.alert import Alert
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
from selenium.common.exceptions import StaleElementReferenceException
from selenium.common.exceptions import TimeoutException
import time
import os
import datetime
from webdriver_manager.chrome import ChromeDriverManager
import requests
import pandas as pd
import csv
from csv import writer
from random import seed
from random import randint

options = webdriver.ChromeOptions()
options.add_argument('--ignore-certificate-errors')
options.add_argument('--user-agent="Mozilla/5.0 (iPhone; CPU iPhone OS 12_1_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/16D57"')

driver = webdriver.Chrome(ChromeDriverManager().install())


driver.get('https://www.instagram.com')
sleep(2)

username_el = driver.find_element_by_name("username")
username_el.send_keys("-----------") #### Input your username or email ####
time.sleep(0.5)
password_el = driver.find_element_by_name("password")
password_el.send_keys("-----------") #### Input your password for your account ####
sleep(0.5)

submit_btn_el = driver.find_element_by_css_selector("button[type='submit']")

submit_btn_el.click()
time.sleep(1)
not_now = WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, "//button[contains(text(), 'Not Now')]"))).click()
time.sleep(1)
not_now2 = WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, "//button[contains(text(), 'Not Now')]"))).click()

hashtags = ['-------', '--------'] ##### Input the name of the Hashtag here #####

li = []
lst = []
print(hashtags)

for i in range(len(hashtags)):

    driver.get("https://www.instagram.com/explore/tags/" + hashtags[i] + "/")

    div1 = 1
    div2 = 0
    div3 = 1
    div4 = 0
    count = 1
    for i in range(1,10): #### Enter the number of posts you want to scrape ######
        print(count)
        if i < 10:
            if i % 3 == 1:
                div2 += 1
                div1 = 1
            value = randint(2,6)
            sleep(value)
            image_button = WebDriverWait(driver, 10).until(lambda d: d.find_element(By.XPATH, '//*[@id="react-root"]/section/main/article/div[1]/div/div/div[%s]/div[%s]/a/div/div[2]' % (div2,div1)))
            image_button.click()
            """
            click_pic = WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, '//*[@id="react-root"]/section/main/article/div[1]/div/div/div[%s]/div[%s]/a/div/div[2]' % (div2,div1)))).click()
            """
            value = randint(1,3)
            sleep(value)

            user_name = WebDriverWait(driver, 10).until(lambda d: d.find_elements(By.CSS_SELECTOR, 'a.sqdOP'))
            username = user_name[0].text
            
            print(username)
            """
            post_pic = driver.find_element_by_css_selector("img.FFVAD")
            """
            post_pic = WebDriverWait(driver, 10).until(lambda d: d.find_elements(By.CSS_SELECTOR, 'img._6q-tv'))
            post_image = post_pic[1].get_attribute('src')
            """
            post_image = post_pic.get_attribute('src')
            """
            print(post_image)
            """
            click_exit = WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, '/html/body/div[5]/div[3]/button'))).click()
            """
            
            exit_button = WebDriverWait(driver, 10).until(lambda d: d.find_element(By.XPATH, '/html/body/div[5]/div[3]/button'))
            exit_button.click()
            
            
            if len(li) == 0:
                li.append([username,post_image])
                lst.append(username)
            else:
                li.append([username,post_image])
                lst.append(username)
            div1 += 1
        else:
            value = randint(2,4)
            sleep(value)
            if div4 != 11:
                if i % 3 == 1:
                    div4 += 1
                    div3 = 1
            else:
                if i % 3 == 1:
                    driver.execute_script("window.scrollBy(0 , 320);")
                    div3 = 1
            value = randint(3,5)
            print(div4,div3)
            sleep(value)
            image_button = WebDriverWait(driver, 10).until(lambda d: d.find_element(By.XPATH, '//*[@id="react-root"]/section/main/article/div[2]/div/div[%s]/div[%s]/a/div[1]/div[2]' % (div4,div3)))
            image_button.click()
            
            value = randint(1,3)
            sleep(value)
            user_name = driver.find_elements_by_css_selector("a.sqdOP")
            """
            user_name = WebDriverWait(driver, 10).until(lambda d: d.find_elements(By.CSS_SELECTOR, 'a.sqdOP'))
            """
            username = user_name[0].text
            print(username)

            post_pic = WebDriverWait(driver, 10).until(lambda d: d.find_elements(By.CSS_SELECTOR, 'img._6q-tv'))
            post_image = post_pic[1].get_attribute('src')
            print(post_image)
            exit_button = WebDriverWait(driver, 10).until(lambda d: d.find_element(By.XPATH, '/html/body/div[5]/div[3]/button'))
            exit_button.click()
            
            li.append([username,post_image])
            lst.append(username)
            div3 += 1
        count += 1
driver.quit()
"""
only_users = pd.DataFrame(lst)
only_users.to_csv('follower_lists.csv', header = False, index = False)
"""
user_plus_url = pd.DataFrame(li)
user_plus_url.to_csv('follower_url.csv', header = False, index = False)

with open('total_follower_data.csv', 'a+', newline='') as write_obj:
    csv_writer = writer(write_obj)
    for i in range(len(li)):
        csv_writer.writerow(li[i])
